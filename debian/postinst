#!/bin/sh

set -e

# Making sure /etc/default/surfids-sensor is set to false
# Reason: The sensor manager is handling the startup of the sensor
echo "ENABLED=\"false\"" > /etc/default/surfids-sensor

chmod 755 /usr/share/python-support/surfids-sensor/sensor/bin/sensor-manager.py
if [ -e "/etc/inittab" ]; then
    if [ ! -e "/etc/backup.inittab" ]; then
        mv -f /etc/inittab /etc/backup.inittab
        sed 's/.*tty1/1:2345:respawn:\/usr\/sbin\/sensor-manager <\/dev\/tty1 >\/dev\/tty1 2>\&1/' /etc/backup.inittab > /etc/inittab
    fi
fi
if [ -e "/etc/event.d/" ]; then
    mv -f /var/lib/surfids/tty1.conf /etc/event.d/tty1
else
    rm -f /var/lib/surfids/tty1.conf
fi

if [ -e "/etc/logrotate.d/" ]; then
    mv -f /var/lib/surfids/logrotate.conf /etc/logrotate.d/surfids-sensor
fi


# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

echo ""
if [ ! -e "/etc/surfids/ca.crt" ]; then
    echo "*) Add your tunnel server ca.crt to /etc/surfids/"
fi

# Handling main configuration file
if [ ! -e "/etc/surfids/surfids.conf" ]; then
    mv -f /etc/surfids/surfids.conf.dist /etc/surfids/surfids.conf
    echo "*) Configure /etc/surfids/surfids.conf"
fi

# Handling the openvpn configuration file
if [ ! -e "/etc/surfids/openvpn.conf" ]; then
    mv -f /etc/surfids/openvpn.conf.dist /etc/surfids/openvpn.conf
    echo "*) Configure /etc/surfids/openvpn.conf"
fi

# Killing sensor-up if it's running
SUPPID=`ps -ef | grep python | grep -v sensor-update | grep sensor-up | awk '{print $2}'`
if [ $SUPPID ]; then
    kill -9 $SUPPID
fi

# Make sure no openvpn is running as this will only mess stuff up
CHK=`ps -ef | grep openvpn | grep -v grep | grep -v dpkg | wc -l`
if [ $CHK -gt 0 ]; then
    killall -q -9 openvpn
fi

# Kill all current sensor scripts to make sure the new scripts
# are being loaded
CHK=`ps -ef | grep python | grep -v grep | grep -v dpkg | wc -l`
if [ $CHK -gt 0 ]; then
    killall -q -9 python
fi

echo ""
echo "NOTE: If this is the first time you have installed surfids-sensor,"
echo "reboot your machine to startup the sensor environment!"
echo ""

exit 0
